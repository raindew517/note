#JavaScript 性能优化

语言层面的性能优化

- 内存管理
- 垃圾回收与常见 GC 算法
- V8 引擎的垃圾回收
- Performance 工具

##JavaScript 内存管理

memory management

- 内存：由可读写单元组成，表示一片可操作空间
- 管理：认为的去操作一片空间的申请、使用和释放
- 内存管理：开发者主动申请空间、使用空间、释放空间

ECMAScript 没有提供相应的操作 api，所以 JavaScript 不能像 C、C++ 那样主动的去动用 API 去操作内存空间

```js
// 申请
let obj = {};
// 使用
obj.name = "obj";
// 释放
obj = null;
```

##JavaScript 垃圾回收

- JavaScript 中内存管理是自动的
- 对象不再被引用时是垃圾
- 对象不能从根上访问到时是垃圾

可达对象

- 可以访问到的对象就是可达对象（引用、作用域链）
- 可达的标准就是从根出发是否能够被找到
- JavaScript 中的根就可以理解为是全局变量是对象

当没有路径能够找到这个对象的时候，这个对象就会被当成垃圾回收

## GC 算法

Garbage Collection，GC 可以找到内存中的垃圾、并释放和回收空间，算法就是工作时查找和回收所遵循的规则

```js
// 程序中不再需要使用的对象
function func() {
	name = 'lg'
	return `${name} is a coder`
}
func()

// 程序中不能再访问到的对象
function func() {
  const name = 'lg'
  return `${name} is a coder`
}
func
```

常见术语

- 引用计数
- 标记清除
- 标记整理
- 分带回收

## 引用计数算法实现原理

- 核心思想：设置引用树，判断当前引用数是否为 0
- 引用计数器
- 引用关系改变时修改引用数字
- 引用数字为 0 时立即回收

### 引用计数算法优缺点

**优点**

- 发现垃圾时立即回收
- 最大限度减少程序暂停
  - 程序执行必然有内存的消耗，内存终归是有上限，总归有占满内存的时候，当内存即将占满的时候，算法就被触发去释放内存，这样来达到减少程序暂停

**缺点**

- 无法回收循环引用的对象
- 时间开销大
  - 引用计数需要去维护数值的变化，对象是很多的，那耗时就也不小，这个耗时是相对于其他算法而言的

## 标记清楚算法

- 核心思想：分标记和清除两个阶段完成
- 遍历所有对象找标记活动对象
- 遍历所有对象清除没有标记对象
- 回收相应的空间

标记阶段就是先从根去查找可达对象，如果有嵌套的对象，就递归查找，然后标记对象，在清除阶段就清除回收没有标记的对象，同时清除所有标记

回收的空间会被放在空闲链表上，方便后续程序在这申请空间使用

### 标记清楚算法优缺点

**优点**

- 解决循环引用的问题（相对引用计数算法而言）

**缺点**

- 空间碎片化
  - 空间都有一部分来存储元信息（数据大小，内存地址等）的，叫“头”，一部来存储数据的，叫“域”，在回收的时候，内存空间的地址是不连续的，这样回收的空间是在各个不同的角落的，大小也不一样，如果需要申请新的内存空间的话，空闲链表中没有一样大小的空间的话，就不太合适复用
- 不会立即回收垃圾对象，清除过程其实程序是停止工作的

## 标记整理算法

- 标记整理可以看做是标记清除的增强
- 标记节点的操作和标记清除算法一致
- 清除阶段会先执行整理，移动对象位置

在清除之前先整理，把不活动的内存空间整理成一段连续的空间，然后再回收空间，这样得到的连续空间就不会有碎片化的问题

缺点也是不会立即回收垃圾对象

## V8

- V8 是一款最主流的 JavaScript 执行引擎
- V8 采用即时编译

